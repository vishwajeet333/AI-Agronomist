<!DOCTYPE html>
<html>
<head>
    <title>AI Agronomist</title>
    <script>
        function updateTelemetry() {
            fetch('/telemetry').then(r => r.json()).then(data => {
                document.getElementById('alt').innerText = data.alt;
                
                var stateText = "IDLE";
                var stateColor = "#444";
                
                if (data.state == 1) { 
                    stateText = "SURVEYING FIELD"; 
                    stateColor = "#004400"; 
                }
                if (data.state == 2) { 
                    stateText = "ANOMALY DETECTED - INSPECTING"; 
                    stateColor = "#cc4400"; 
                }
                
                var stateBox = document.getElementById('state-box');
                stateBox.innerText = stateText;
                stateBox.style.backgroundColor = stateColor;
                
                document.getElementById('ndvi').innerText = data.ndvi; 
                document.getElementById('temp').innerText = data.temp;
                document.getElementById('status').innerText = data.status;

                updateGrid(data.lat, data.lon, data.ndvi);
            });
        }

        function updateGrid(lat, lon, ndvi) {
            var x = Math.floor(lon / 0.000015) + 2; 
            var y = Math.floor(lat / 0.000015) + 2;

            if (x >= 0 && x < 10 && y >= 0 && y < 10) {
                var cellId = "cell-" + (9-y) + "-" + x;
                var cell = document.getElementById(cellId);
                
                if (cell) {
                    var hue = 30 + (ndvi * 90); 
                    if (hue < 0) hue = 0;
                    if (hue > 120) hue = 120;

                    cell.style.backgroundColor = `hsl(${hue}, 100%, 40%)`;
                    
                    cell.style.border = "2px solid white";
                    setTimeout(() => { cell.style.border = "1px solid #333"; }, 1000);
                }
            }
        }

        function sendCommand(route) { 
            fetch(route).then(r => r.json()).then(data => alert(data.message));
        }
        
        setInterval(updateTelemetry, 500); 
    </script>
    <style>
        body { font-family: 'Courier New', monospace; background: #0f0f0f; color: #eee; text-align: center; margin: 0; padding: 20px; }
        h1 { font-size: 24px; margin-bottom: 10px; color: #fff; text-transform: uppercase; letter-spacing: 2px; }
        h2 { font-size: 14px; color: #aaa; margin-bottom: 5px; border-bottom: 1px solid #444; padding-bottom: 5px;}
        .dashboard { display: flex; justify-content: center; gap: 20px; margin-top: 20px; flex-wrap: wrap; }
        .panel { background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 15px; width: 280px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .metric-row { display: flex; justify-content: space-between; margin: 8px 0; font-size: 18px; }
        .label { color: #888; font-size: 14px; align-self: center; }
        .value { font-weight: bold; color: #fff; }
        #state-box { padding: 15px; font-weight: bold; color: #fff; border-radius: 5px; margin-bottom: 15px; border: 1px solid #555; transition: background-color 0.5s; }
        #map-container { display: grid; grid-template-columns: repeat(10, 25px); grid-template-rows: repeat(10, 25px); gap: 2px; margin: 10px auto; width: fit-content; background: #000; padding: 5px; border: 1px solid #555; }
        .grid-cell { width: 25px; height: 25px; background-color: #222; }
        button { background: #0066cc; color: white; border: none; padding: 12px 25px; font-size: 14px; font-weight: bold; border-radius: 4px; cursor: pointer; margin-top: 20px; letter-spacing: 1px; }
        button:hover { background: #0055aa; }
        .btn-launch { background: #228b22; }
        .btn-launch:hover { background: #1a6b1a; }
    </style>
</head>
<body>

    <h1>AI Agronomist</h1>
    
    <div style="max-width: 600px; margin: 0 auto;">
        <div id="state-box">SYSTEM IDLE</div>
    </div>

    <div class="dashboard">
        <div class="panel">
            <h2>LIVE SENSOR DATA</h2>
            <div class="metric-row"><span class="label">ALTITUDE</span><span class="value"><span id="alt">0</span> m</span></div>
            <hr style="border-color:#333">
            <div class="metric-row"><span class="label">INDEX (NDVI)</span><span class="value" id="ndvi" style="color: lightgreen;">0.00</span></div>
            <div class="metric-row"><span class="label">FEATURE (TEMP)</span><span class="value"><span id="temp">0</span> C</span></div>
            <div class="metric-row"><span class="label">CLASSIFICATION</span><span class="value" id="status">--</span></div>
        </div>

        <div class="panel">
            <h2>SPATIAL VISUALIZATION</h2>
            <div id="map-container">
                <script>
                    for(let y=0; y<10; y++) {
                        for(let x=0; x<10; x++) {
                            document.write('<div id="cell-' + y + '-' + x + '" class="grid-cell"></div>');
                        }
                    }
                </script>
            </div>
            <div style="font-size: 10px; color: #666; display: flex; justify-content: space-between; padding: 0 10px;">
                <span>Low NDVI (Brown)</span><span>High NDVI (Green)</span>
            </div>
        </div>
    </div>

    <br>
    <button class="btn-launch" onclick="sendCommand('/takeoff')">LAUNCH DRONE</button>
    <button onclick="sendCommand('/fly_mission')">START ADAPTIVE MISSION</button>

</body>
</html>
